#!/usr/bin/env bash
set -e
set -o xtrace

export $GIT_COMMIT="$(git rev-parse --short HEAD)"

lein uberjar

docker build -t eu.gcr.io/aidbox-next/ci3:$GIT_COMMIT .
docker tag eu.gcr.io/aidbox-next/ci3:$GIT_COMMIT eu.gcr.io/aidbox-next/ci3:latest
docker push eu.gcr.io/aidbox-next/ci3:$GIT_COMMIT
docker push eu.gcr.io/aidbox-next/ci3:latest
helm upgrade --set image.tag=$GIT_COMMIT,image.repository=eu.gcr.io/aidbox-next/ci3 -i web-hook ci3

